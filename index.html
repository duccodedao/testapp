<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Connect Ref A</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/ton-connect-ui.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
            padding: 20px;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        h1 {
            color: #007bff;
            margin-bottom: 20px;
        }
        #ton-connect {
            margin-top: 25px;
            /* Basic styling for the button generated by TonConnect UI */
        }
        #ton-connect > button {
            background-color: #007bff !important;
            color: white !important;
            border: none !important;
            padding: 12px 25px !important;
            border-radius: 8px !important;
            font-size: 1.1em !important;
            cursor: pointer !important;
            transition: background-color 0.3s ease !important;
        }
        #ton-connect > button:hover {
            background-color: #0056b3 !important;
        }
        .status-box {
            margin-top: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: left;
            font-size: 0.9em;
        }
        .status-box p {
            margin: 5px 0;
        }
        .status-box strong {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Connect Your TON Wallet</h1>
        <p>Click the button below to connect your wallet via TonConnect UI.</p>

        <div id="ton-connect"></div>

        <div class="status-box">
            <p><strong>Wallet Status:</strong> <span id="walletStatus">Not Connected</span></p>
            <p><strong>Connected Address:</strong> <span id="walletAddress">N/A</span></p>
            <p><strong>Telegram User:</strong> <span id="telegramUser">N/A</span></p>
            <p><strong>Telegram User ID:</strong> <span id="telegramUserId">N/A</span></p>
        </div>
    </div>

    <script>
        // Ensure Telegram Web App is ready if launched from Telegram
        let tgWebAppUser = null;
        if (window.Telegram && window.Telegram.WebApp) {
            telegram.WebApp.ready();
            // You might want to expand the web app
            // telegram.WebApp.expand();

            // Try to get user data from initDataUnsafe
            if (telegram.WebApp.initDataUnsafe && telegram.WebApp.initDataUnsafe.user) {
                tgWebAppUser = telegram.WebApp.initDataUnsafe.user;
                document.getElementById('telegramUser').textContent = `@${tgWebAppUser.username || tgWebAppUser.first_name}`;
                document.getElementById('telegramUserId').textContent = tgWebAppUser.id;
                console.log('Telegram Web App User:', tgWebAppUser);
            } else {
                document.getElementById('telegramUser').textContent = 'User data unavailable.';
                console.warn('Telegram Web App user data not available.');
            }
        } else {
            document.getElementById('telegramUser').textContent = 'Not in Telegram Web App.';
            console.warn('Telegram Web App JS API not loaded or not in Telegram environment.');
        }

        // Initialize TonConnect UI
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            // IMPORTANT: Replace 'https://<YOUR_APP_URL>' with your actual domain.
            // Example: 'https://bmweb.site/tonconnect-manifest.json'
            manifestUrl: 'https://bmweb.site/tonconnect-manifest.json', // Your actual manifest URL
            buttonRootId: 'ton-connect' // This tells TonConnect UI where to render its button
        });

        // Set UI options, including twaReturnUrl for Telegram Web Apps
        tonConnectUI.uiOptions = {
            // Replace 'YOUR_APP_NAME' with the @username of your Telegram bot.
            // This is crucial for the wallet app to return correctly to your bot after connection.
            twaReturnUrl: 'https://t.me/YOUR_BOT_USERNAME' // e.g., 'https://t.me/MyAwesomeTonBot'
        };

        // Listen for wallet connection status changes
        tonConnectUI.onStatusChange(wallet => {
            const walletStatusElement = document.getElementById('walletStatus');
            const walletAddressElement = document.getElementById('walletAddress');

            if (wallet) {
                walletStatusElement.textContent = 'Connected!';
                walletStatusElement.style.color = 'green';
                walletAddressElement.textContent = wallet.account.address;
                console.log('Wallet Connected:', wallet.account.address);

                // --- IMPORTANT FOR YOUR PROJECT ---
                // At this point, you have:
                // 1. wallet.account.address (the user's TON wallet address)
                // 2. tgWebAppUser.id (the user's Telegram ID, if launched from Telegram)
                // 3. tgWebAppUser.username (the user's Telegram username, if available)

                // You should now send this data to your backend server
                // to link the wallet to the Telegram user and start tracking points.
                // Example (replace with your actual API call):
                // fetch('/api/link-ton-telegram', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({
                //         walletAddress: wallet.account.address,
                //         telegramId: tgWebAppUser ? tgWebAppUser.id : null,
                //         telegramUsername: tgWebAppUser ? tgWebAppUser.username : null
                //     })
                // })
                // .then(response => response.json())
                // .then(data => console.log('Backend response:', data))
                // .catch(error => console.error('Error sending data to backend:', error));

            } else {
                walletStatusElement.textContent = 'Not Connected';
                walletStatusElement.style.color = 'red';
                walletAddressElement.textContent = 'N/A';
                console.log('Wallet Disconnected.');
            }
        });

        // There's no need to call connectToWallet() directly on page load
        // because tonConnectUI.renderConnectButton() will display a button for the user to click.
        // The TonConnect UI handles the actual connection flow.
    </script>
</body>
</html>
